name: Validate PowerShell

on:
  push:
    branches: [master, main, dev]
  pull_request:
    branches: [master, main, dev]
  workflow_dispatch:

jobs:
  validate:
    name: Validate Scripts
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate PowerShell syntax
        shell: pwsh
        run: |
          $errors = @()
          Get-ChildItem -Path . -Filter "*.ps1" -Recurse | ForEach-Object {
            $file = $_.FullName
            $content = Get-Content -Path $file -Raw
            $parseErrors = $null
            [System.Management.Automation.Language.Parser]::ParseInput($content, [ref]$null, [ref]$parseErrors) | Out-Null
            if ($parseErrors) {
              $errors += "Syntax errors in $($_.Name):"
              $parseErrors | ForEach-Object { $errors += "  Line $($_.Extent.StartLineNumber): $($_.Message)" }
            }
          }

          Get-ChildItem -Path . -Filter "*.psm1" -Recurse | ForEach-Object {
            $file = $_.FullName
            $content = Get-Content -Path $file -Raw
            $parseErrors = $null
            [System.Management.Automation.Language.Parser]::ParseInput($content, [ref]$null, [ref]$parseErrors) | Out-Null
            if ($parseErrors) {
              $errors += "Syntax errors in $($_.Name):"
              $parseErrors | ForEach-Object { $errors += "  Line $($_.Extent.StartLineNumber): $($_.Message)" }
            }
          }

          if ($errors.Count -gt 0) {
            $errors | ForEach-Object { Write-Error $_ }
            exit 1
          }
          Write-Host "All PowerShell files validated successfully!" -ForegroundColor Green

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $results = Get-ChildItem -Path . -Include "*.ps1","*.psm1" -Recurse |
            ForEach-Object { Invoke-ScriptAnalyzer -Path $_.FullName -Severity Error,Warning }

          if ($results) {
            $results | Format-Table -AutoSize
            $errorCount = ($results | Where-Object Severity -eq "Error").Count
            if ($errorCount -gt 0) {
              Write-Error "Found $errorCount error(s)"
              exit 1
            }
          }
          Write-Host "PSScriptAnalyzer passed!" -ForegroundColor Green

      - name: Test module import
        shell: pwsh
        run: |
          try {
            Import-Module ./MatrixCommands.psm1 -Force -ErrorAction Stop
            Write-Host "Module imported successfully!" -ForegroundColor Green

            # Verify expected functions exist
            $expectedFunctions = @('neo', 'hacker', 'matrix', 'whiterabbit')
            foreach ($func in $expectedFunctions) {
              if (Get-Command $func -ErrorAction SilentlyContinue) {
                Write-Host "  Found function: $func" -ForegroundColor Green
              } else {
                Write-Error "Missing expected function: $func"
                exit 1
              }
            }
          } catch {
            Write-Error "Failed to import module: $_"
            exit 1
          }
